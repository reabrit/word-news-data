<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="Imges\favicon-192.png" type="image/x-icon">
    <title>å•è¯ç®€è®¯- æç®€å­¦ä¹ å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'å¾®è½¯é›…é»‘', sans-serif;
        }

        body {
            min-height: 100vh;
            color: rgba(255,255,255,0.9);
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            z-index: 1;
        }

        .login-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.08);
    padding: 2rem 3rem 2.5rem;
    border-radius: 15px;
    backdrop-filter: blur(12px) saturate(180%);
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    z-index: 2;
    transition: all 0.3s ease;
}

         /* æ–°å¢é€‰é¡¹äº¤äº’æ•ˆæœ */
         .option:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .option {
            transition: all 0.2s ease;
        }
        /* æ–°å¢æ˜ç¡®çš„çŠ¶æ€é¢œè‰² */
        .option.correct {
            background: #00ff88 !important;
            color: #16213e !important;
            transform: scale(1.02);
        }
        .option.wrong {
            background: #ff4444 !important;
            color: white !important;
            animation: shake 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }
        /* é€€å‡ºæŒ‰é’®æ ·å¼ */
        .exit-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ff4444 !important;
            padding: 0.5rem 1rem !important;
        }
        /* æ–°å¢ä¸‹æ‹‰æ¡†æ ·å¼ */
        select.form-input {
            color: #16213e !important;
            background: rgba(255,255,255,0.9) !important;
        }

        /* æ–°å¢é”™é¢˜æœ¬æ“ä½œæ ·å¼ */
        .wrong-actions {
            margin: 0 0 1rem 0; /* ä¸‹è¾¹è·1remé˜²æ­¢æŒ¤å‹å†…å®¹ */
            display: flex;
            gap: 8px;
            flex-wrap: nowrap; /* ç¦æ­¢æ¢è¡Œ */
        }
        .wrong-actions .primary-btn {
    flex: 1; /* å…è®¸æŒ‰é’®ä¼¸ç¼© */
    min-width: 120px; /* è®¾ç½®æœ€å°å®½åº¦ */
    padding: 0.6rem 0.8rem; /* è°ƒæ•´å†…è¾¹è· */
    font-size: 0.9em;
}

/* ä¸‰æ å¸ƒå±€ */
.columns {
    display: grid;
    grid-template-columns: 300px 1fr 320px;
    gap: 1.5rem;
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* å“åº”å¼å¸ƒå±€ */
@media (max-width: 1024px) {
    .columns {
        display: block !important;
        position: relative;
        height: calc(100vh - 180px);
    }

    .column {
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        height: auto;
        min-height: 100%;
        max-height: 80vh !important; /* è°ƒæ•´çˆ¶å®¹å™¨é«˜åº¦ */
        overflow: hidden;
        display: none !important;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease-out;
        z-index: 0;
    }
    #wordList {
        max-height: 12vh !important; /* é™ä½å¯è§†åŒºåŸŸé«˜åº¦ */
        min-height: 200px;
        overflow-y: auto !important; /* å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
    }
    
    /* é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ¿å— */
    #wordLib {
        display: block !important; /* è¦†ç›–é»˜è®¤éšè— */
    }
    .column.active-section {
        display: flex !important;
        opacity: 1;
        transform: translateY(0);
        z-index: 1;
    }
    
    .mobile-nav {
        position: sticky;
        top: 0;
        z-index: 2;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
}
/* æ–°å¢CSSåŠ¨ç”» */
@keyframes sectionSlide {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}
.active-section {
    animation: sectionSlide 0.3s ease-out;
}

@media (max-width: 768px) {
    #wordList {
        -webkit-overflow-scrolling: touch; /* å¯ç”¨æƒ¯æ€§æ»šåŠ¨ */
        overscroll-behavior: contain; /* é˜²æ­¢æ»šåŠ¨ç©¿é€ */
        max-height: 50vh !important;
    }
    .column {
        max-height: 70vh !important;
        padding: 1rem !important;
    }
    .mode-group {
        flex-basis: 28%; /* ä¸‰ä¸ªå…ƒç´ å„å 28%å®½åº¦ */
    }
    .start-btn {
        flex-basis: 16%; /* æŒ‰é’®å å‰©ä½™å®½åº¦ */
    }
    .main-container {
        padding: 1rem 0.5rem !important;
    }
    
    h1 {
        font-size: 2rem !important;
        margin: 1rem 0 !important;
    }
    
    h2 {
        font-size: 1.5rem !important;
    }
    
    .mode-selector {
        flex-direction: column;
        gap: 0.8rem;
    }
    
    select.form-input,
    .primary-btn {
        width: 100% !important;
        font-size: 1rem !important;
        padding: 1rem !important;
    }
    
    .stats-bar {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        padding: 0.8rem;
    }
    
    .word-item {
        padding: 0.8rem;
        font-size: 0.95em;
        min-height: 40px;
    }
    
    .voice-btn {
        width: 36px;
        height: 36px;
        padding: 0.5rem !important;
    }
    
    #pronunciationType {
        left: 4.5rem;
        top: 0.8rem;
        width: 110px;
        padding: 0.3rem;
    }
}
/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 1280px) {
    .columns {
        grid-template-columns: 280px 1fr 300px;
    }
    
    .wrong-actions .primary-btn {
        font-size: 0.85em;
        padding: 0.6rem;
    }
}
/* æ–°å¢ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ */
@media (max-width: 480px) {
    .nav-btn {
        padding: 0.8rem;
        font-size: 0.8em;
    }
    
    .column {
        padding: 1rem;
    }
    
    h1 {
        font-size: 2rem !important;
        margin: 0.5rem 0 !important;
    }
    
    .word-item {
        padding: 0.8rem;
        font-size: 0.9em;
    }
    .login-logo {
        width: 80px;
        height: 80px;
        margin-bottom: 1rem;
    }
    
    .login-container {
        padding: 1.5rem;
        width: 90%;
    }
    .wrong-actions {
        flex-wrap: wrap;
    }
    .wrong-actions .primary-btn {
        flex: 1 1 100%;
        font-size: 0.8em;
    }
    .wrong-actions button {
        flex: 1 1 100%;
    }
}
/* ä¿®å¤è¯åº“å¸ƒå±€ */
.column {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    height: auto;
    min-height: 700px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
}
/* è¯åº“åˆ—è¡¨å®¹å™¨ */
#wordList {
    flex: 1;
    overflow-y: auto; /* ä¿ç•™ç«–è½´æ»šåŠ¨æ¡ */
    overflow-x: hidden; /* éšè—æ¨ªè½´æ»šåŠ¨æ¡ */
    margin: 1rem 0;
    scrollbar-width: thin;
    height: 60vh;
    padding: 0;
    position: relative;
    scrollbar-color: #00ff88 rgba(255,255,255,0.1);
}
/* è™šæ‹Ÿæ»šåŠ¨å ä½å…ƒç´ æ ·å¼ */
#wordList > div:first-child {
    position: absolute;
    width: 100%;
    pointer-events: none;
}
/* æŒ‰é’®å®¹å™¨ */
#wordForm {
    background: rgba(255,255,255,0.05);
    padding: 0.8rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
} 
/* è¾“å…¥æ¡†èšç„¦çŠ¶æ€ */
#wordForm .form-input:focus {
    border-color: #00ff88;
    box-shadow: 0 0 8px rgba(0,255,136,0.2);
}

/* æŒ‰é’®äº¤äº’çŠ¶æ€ */
#wordForm button {
    transition: all 0.2s ease;
    flex: 1;
}

#wordForm button:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}

#wordForm button:active {
    transform: translateY(1px);
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
    #wordForm {
        padding: 0.6rem;
    }
    
    #wordForm .form-input {
        padding: 0.6rem;
    }
    
    #wordForm button {
        padding: 0.6rem;
        font-size: 0.9em;
    }
}
/* è¾“å…¥æ¡†èšç„¦çŠ¶æ€ */
#wordForm .form-input:focus {
    border-color: #00ff88;
    box-shadow: 0 0 8px rgba(0,255,136,0.2);
}
        .login-form input {
            display: block;
            width: 280px;
            margin: 1.2rem 0;
            padding: 1rem;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 12px rgba(0,255,136,0.2);
        }

        .login-form button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            color: #16213e;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        /* æ–°å¢Logoæ ·å¼ */
.login-logo {
    width: 240px;
    height: 80px;
    margin: 0 auto 1.5rem;
    display: block;
    filter: drop-shadow(0 2px 8px rgba(83,106,232,0.37));
    animation: logoFloat 3s ease-in-out infinite;
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
/* æ–°å¢ä¸»é¡µLOGOæ ·å¼ */
.main-logo {
    position: absolute;
    top: 1.5rem;
    left: 2rem;
    width: 200px;
    height: 60px; /* æ–°å¢é«˜åº¦è®¾ç½® */
    object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
    z-index: 3;
    filter: drop-shadow(0 2px 8px rgba(83,106,232,0.37));
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .main-logo {
        width: 90px;
        height: 30px; /* ç§»åŠ¨ç«¯å¯¹åº”é«˜åº¦ */
        top: 1rem;
        left: 1rem;
    }
}

        .main-container {
            display: none;
            padding: 2rem;
            position: relative;
            z-index: 2;
        }

        .columns {
            display: grid;
            grid-template-columns: 400px 1fr 300px;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .column {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    min-height: 500px; /* æœ€å°é«˜åº¦ä¿æŒ500px */
    max-height: 70vh;
    overflow: hidden; /* æ–°å¢ */
}
/* æ–°å¢æ—¶é—´æ˜¾ç¤ºæ ·å¼ */
.time-display {
    font-size: 1.2em;
    color: #00ff88;
    margin: 1rem 0;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

/* åˆ—è¡¨é¡¹ */
.word-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.4rem 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    min-height: 36px;
    margin: 1px 0;
    font-size: 0.88em;
    transition: 
        background 0.2s ease-out,
        transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* ä¿®æ”¹æ—¶é—´å‡½æ•° */
    backface-visibility: hidden; /* æ–°å¢ï¼šä¿®å¤æ¸²æŸ“é—®é¢˜ */
    transform: translateZ(0); /* æ–°å¢ï¼šGPUåŠ é€Ÿ */
}


.word-item:hover {
    background: rgba(0, 68, 141);
    transform: translateX(8px) translateZ(0);  /* åŠ å¤§ä½ç§»é‡ */
    margin-bottom: 5px;      /* æ‚¬åœæ—¶å¾®è°ƒé—´è· */
}
#wrongWords .word-item:hover {
    background: rgba(0, 68, 141);
    transform: translateX(8px) translateZ(0);  /* åŠ å¤§ä½ç§»é‡ */
    margin-bottom: 5px;      /* æ‚¬åœæ—¶å¾®è°ƒé—´è· */
}


        #wordList::-webkit-scrollbar {
            width: 8px;
    height: 8px;
    background: rgba(255,255,255,0.05);
}

#wordList::-webkit-scrollbar-corner {
    background: transparent;
}       

        #wordList::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        #wordList::-webkit-scrollbar,
#wrongWords::-webkit-scrollbar {
    width: 6px; /* æ»šåŠ¨æ¡å®½åº¦ */
    height: 6px; /* æ»šåŠ¨æ¡é«˜åº¦ */
}
#wordList::-webkit-scrollbar-thumb {
    background: #00ff88;
    border-radius: 4px;
    border: 2px solid rgba(0,0,0,0.2);
    background-clip: padding-box;
}


#wordList::-webkit-scrollbar-track,
#wrongWords::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
}

#wordList::-webkit-scrollbar-thumb,
#wrongWords::-webkit-scrollbar-thumb {
    background: #00ff88;
    border-radius: 3px;
    border: 1px solid rgba(0,0,0,0.2);
}

        .study-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(22,33,62,0.95);
            display: none;
            z-index: 999;
        }

        .card {
    position: relative; /* æ–°å¢å®šä½ä¸Šä¸‹æ–‡ */
    background: rgba(255,255,255,0.95);
    color: #16213e;
    padding: 3rem;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    margin: 10rem auto;
    box-shadow: 0 12px 30px rgba(0,0,0,0.2);
}

        .options {
            display: grid;
            gap: 1.2rem;
            margin-top: 2.5rem;
        }

        .option {
            padding: 1.2rem;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .correct { background: #00ff88 !important; }
        .wrong { background: #ff4444 !important; color: white; }

        .search-input, .form-input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: white;
            margin: 1rem 0;
        }

        .primary-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    color: #16213e;
    font-weight: bold;
    cursor: pointer;
    margin: 0.6rem 0;
    height: 3rem;
    transition: all 0.3s ease;
        }
        .primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
}
.primary-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0, 255, 136, 0.3);
}

        .danger-btn {
            background: #ff4444 !important;
            color: white !important;
        }
        .danger-btn:hover {
    background: #ff6666 !important;
}
        .file-input {
            position: relative;
            overflow: hidden;
        }
        .file-input input {
            position: absolute;
            font-size: 100px;
            right: 0;
            top: 0;
            opacity: 0;
        }
         /* æ–°å¢é”™é¢˜æœ¬æ ·å¼ */
         #wrongWords {
            display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 240px;
    padding: 0rem 0.3rem;
    overflow-y: auto; /* ä¿ç•™ç«–è½´æ»šåŠ¨æ¡ */
    overflow-x: hidden; /* éšè—æ¨ªè½´æ»šåŠ¨æ¡ */
    scrollbar-width: thin;
    scrollbar-color: #00ff88 rgba(255,255,255,0.1);
}
#wrongWords .word-item {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem; /* å†…è¾¹è·å‡å°‘ */
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
    min-height: 30px; /* å›ºå®šæœ€å°é«˜åº¦ */
    transition: all 0.2s ease;
}
.word-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 1.2rem;  /* å¢åŠ æ°´å¹³å†…è¾¹è· */
    background: rgba(255,255,255,0.05);
    border-radius: 8px;      /* å¢å¤§åœ†è§’ */
    min-height: 44px;       /* å¢åŠ æœ€å°é«˜åº¦ */
    margin: 4px 0 !important; /* ç»Ÿä¸€å¤–è¾¹è· */
    font-size: 0.92em;
    transition: 
        transform 0.25s cubic-bezier(0.23, 1, 0.32, 1),
        background 0.3s ease;
    backface-visibility: hidden;
    transform: translateZ(0);
    box-sizing: border-box;  /* æ–°å¢ */
    will-change: transform;  /* æ˜ç¡®å£°æ˜å˜æ¢å±æ€§ */
}




        #wrongWords::-webkit-scrollbar {
            width: 6px;
        }

        #wrongWords::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        #wrongWords::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 3px;
        }

        

        .wrong-count {
            color: #ff4444;
            font-size: 0.9em;
            margin-left: 8px;
        }
  /* æ–°å¢ç»Ÿè®¡é¢æ¿æ ·å¼ */
  .stats-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
    background: rgba(255, 255, 255, 0.05);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        .stat-item {
            text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
        }
        .stat-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

        .stat-label {
            font-size: 0.9em;
            color: #00ff88;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 1.6em;
    font-weight: bold;
    color: #fff;
        }

        /* æ–°å¢ç»“æœå¡ç‰‡æ ·å¼ */
        .result-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 12px 30px rgba(0,0,0,0.3);
            border: 2px solid #00ff88;
            max-width: 500px;
            width: 90%;
            z-index: 1000;
            animation: popIn 0.6s ease;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .result-title {
            font-size: 2.2em;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .result-emoji {
            font-size: 1.5em;
        }
        .result-score {
            font-size: 3.5em;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 1rem 0;
        }
        .result-message {
            font-size: 1.1em;
            line-height: 1.6;
            margin: 1.5rem 0;
            padding: 1.2rem;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 4px solid #00ff88;
        }

        .voice-btn {
    position: absolute;
    top: 1.5rem;    /* è°ƒæ•´é¡¶éƒ¨è·ç¦» */
    left: 1.5rem;   /* è°ƒæ•´å·¦ä¾§è·ç¦» */
    background: rgba(255,255,255,0.15) !important;
    padding: 0.6rem !important;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.2);
    z-index: 1; /* æ–°å¢å±‚çº§æ§åˆ¶ */
}
/* æ‰‹æœºç«¯é€‚é… */
@media (max-width: 768px) {
    .voice-btn {
        top: 1rem;
        left: 1rem;
        width: 35px;
        height: 35px;
        padding: 0.5rem !important;
    }
    #dashboard {
        height: auto;
        padding: 1rem;
    }

    .stats-panel {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        padding: 1rem;
    }

    .stat-item {
        padding: 0.8rem;
    }

    .stat-label {
        font-size: 0.8em;
    }

    .stat-value {
        font-size: 1.4em;
    }
}
/* ============== å¢åŠ åŠ¨ç”»æ•ˆæœ ============== */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-out;
}

/*è¿™é‡Œç»“æŸ*/
#pronunciationType {
    position: absolute;
    top: 0.5rem;
    left:  5rem;
    width: 120px;
}
/* æ‹¼å†™è¾“å…¥æ¡† */
.spell-input {
    margin: 2rem auto;
    width: 80%;
    padding: 1rem;
    font-size: 1.2em;
    border: 2px solid #00ff88;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: block; /* ç¡®ä¿å±…ä¸­æ˜¾ç¤º */
}
/* æ–°å¢ç­”æ¡ˆåé¦ˆåŠ¨ç”» */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}
.spell-input.correct, .spell-input.wrong {
    animation: pulse 0.5s ease;
}

/* å›¾è¡¨å®¹å™¨ */
#dashboard {
    margin-top: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    height: 135px; /* å›ºå®šé«˜åº¦ */
}
/* æ‹¼å†™è¾“å…¥æ¡†çŠ¶æ€ */
.spell-input.correct {
    border-color: #00ff88 !important;
    background: rgba(0,255,136,0.1) !important;
}

.spell-input.wrong {
    border-color: #ff4444 !important;
    background: rgba(255,68,68,0.1) !important;
}
/* æ–°å¢æ¨¡å¼é€‰æ‹©å™¨æ ·å¼ */
.mode-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    display: flex;
    gap: 1rem;
    align-items: stretch;
    margin-bottom: 1rem;

}
.stats-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.1rem;
    margin-top: 0.1rem;
    padding: 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
}

.word-display {
    font-size: 2em;
    text-align: center;
    margin: 2rem 0;
    padding: 1.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
}

/* æ–°å¢ç§»åŠ¨ç«¯å¯¼èˆªæ ·å¼ */
.mobile-nav {
    display: none;
    position: sticky;
    top: 0;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    z-index: 100;
    padding: 0.5rem;
    margin-bottom: 1rem;
    border-radius: 12px;
}

.nav-btn {
    flex: 1;
    background: none;
    border: none;
    color: white;
    padding: 1rem;
    font-size: 0.9em;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.nav-btn.active {
    background: rgba(0,255,136,0.2);
    color: #00ff88;
}

    </style>
</head>
<body>
    <div id="particles-js"></div>
  <!-- ç™»å½•è¡¨å• -->
  <div class="login-container">
    <form class="login-form" onsubmit="return login(event)">
        <img src="Imges\logo.png" class="login-logo">
        <input type="text" id="username" placeholder="ç”¨æˆ·å" required>
        <input type="password" id="password" placeholder="å¯†ç " required>
        <button type="submit">è¿›å…¥ç³»ç»Ÿ</button>
    </form>
</div>
   <!-- ä¸»å®¹å™¨ -->
<div class="main-container">
    <img src="Imges\logo.png" class="main-logo" alt="PCB-å•è¯ç®€è®¯">
    <h1>PCB-å•è¯ç®€è®¯</h1>
    <div style="text-align: right; margin: -0.8rem 16rem 1.5rem 0; color: #c0c0c0; font-size: 0.85em;">
        ä¸€ä¸ªè½»é‡åŒ–çš„DIYå•è¯åŠ
    </div>
    <div style="text-align: right; margin: -0.8rem 16rem  0.5rem 0; color: #c0c0c0; font-size: 0.85em;">
        Dev:Timi
    </div>

<!-- åœ¨main-containerå†…æ·»åŠ ç§»åŠ¨ç«¯å¯¼èˆª -->
<div class="mobile-nav" id="mobileNav">
    <button class="nav-btn" 
            data-section="wordLib" 
            onclick="showSection('wordLib')">ğŸ“š è¯åº“</button>
    <button class="nav-btn"
            data-section="studyMode"
            onclick="showSection('studyMode')">ğŸš€ å­¦ä¹ </button>
    <button class="nav-btn"
            data-section="statsPanel"
            onclick="showSection('statsPanel')">ğŸ“ˆ æ•°æ®</button>
</div>
    <!-- ä¸‰æ å¸ƒå±€å®¹å™¨ -->
    <div class="columns" id="mainColumns">
     <!-- å·¦ä¾§è¯åº“ -->
<div class="column">
    <h2>ğŸ“š æˆ‘çš„è¯åº“</h2>
    <div class="import-export">
        <div class="file-input">
            <button class="primary-btn" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å•è¯</button>
            <input type="file" id="fileInput" accept=".txt" hidden>
        </div>
        <button class="primary-btn" onclick="exportWords()">ğŸ“¤ å¯¼å‡ºå•è¯</button>
        <button class="primary-btn danger-btn" onclick="deleteAllWords()">âš ï¸ æ¸…ç©ºè¯åº“</button>
    </div>
    <input type="text" id="searchInput" placeholder="ğŸ” è¾“å…¥ä¸­è‹±æ–‡æœç´¢" class="search-input">
    <div style="color: #00ff88; margin: 0.5rem 0; font-size: 0.9em;" id="wordCount">0ä¸ªå•è¯</div>
    
    <!-- è¯åº“åˆ—è¡¨ -->
    <div id="wordList"></div>

    <!-- æ·»åŠ è¡¨å• -->
    <div id="wordForm" style="display: none; margin-top: 0.5rem;">
        <input type="text" id="enInput" placeholder="è‹±æ–‡" class="form-input">
        <input type="text" id="cnInput" placeholder="ä¸­æ–‡" class="form-input">
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="primary-btn" onclick="addWord(event)">ğŸ’¾ ä¿å­˜</button>
            <button class="primary-btn danger-btn" onclick="toggleWordForm()">âœ–ï¸ å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ·»åŠ æŒ‰é’® -->
    <div class="button-container">
        <button class="primary-btn" onclick="toggleWordForm()">â• æ·»åŠ æ–°è¯</button>
    </div>
</div>


        <!-- ä¸­é—´å­¦ä¹  -->
        <div class="column">
            <h2>ğŸš€ å­¦ä¹ æŒ‘æˆ˜</h2>
            <div class="mode-selector">
                <div class="mode-group">
                    <select id="challengeCount" class="form-input">
                        <option value="20">ğŸ¯ 20é¢˜</option>
                        <option value="50">ğŸ”¥ 50é¢˜</option>
                        <option value="100">ğŸš© 100é¢˜</option>
                        <option value="300">ğŸ’ª 300é¢˜</option>
                        <option value="500">ğŸ† 500é¢˜</option>
                    </select>
                </div>
                <div class="mode-group">
                    <select id="challengeMode" class="form-input">
                        <option value="choice">ğŸ“ é€‰æ‹©é¢˜æ¨¡å¼</option>
                        <option value="spell">âœï¸ æ‹¼å†™æ¨¡å¼</option>
                    </select>
                </div>
                <button class="primary-btn start-btn" onclick="startLearning()">â–¶ï¸ å¼€å§‹æŒ‘æˆ˜</button>
            </div>
        </div>

        <!-- å³ä¾§ç»Ÿè®¡ -->
        <div class="column">
            <h2>ğŸ“ˆ å­¦ä¹ æ•°æ®</h2>
            <div id="dashboard">
                <canvas id="progressChart"></canvas>
            </div>
            <div class="time-display">
                <span id="currentTime"></span>
            </div>
            <div class="stats-bar">
                <div>ğŸ“š æ€»è¿›åº¦ï¼š<span id="progressRate">0%</span></div>
                <div>ğŸ¯ æŒ‘æˆ˜æ¨¡å¼ï¼š<span id="normalAccuracy">0%</span></div>
                <div>ğŸ” å¤ä¹ æ¨¡å¼ï¼š<span id="reviewAccuracy">0%</span></div>
            </div>
            <h3>ğŸ“– é”™é¢˜æœ¬<span class="wrong-count" id="wrongCount">(0)</span></h3>
            <div class="wrong-actions">
                <button class="primary-btn" onclick="exportWrongWords()">ğŸ“¤ å¯¼å‡ºé”™é¢˜</button>
                <button class="primary-btn" onclick="startReview()" id="reviewBtn" hidden>ğŸ” é”™é¢˜å¤ä¹ </button>
            </div>
            <div id="wrongWords"></div>
        </div>
    </div> <!-- ç»“æŸ.columnså®¹å™¨ -->
</div> <!-- ç»“æŸ.main-container -->
<!-- æ–°å¢å­¦ä¹ å®¹å™¨ï¼ˆæ·»åŠ åˆ°bodyæœ«å°¾ï¼Œmain-containerä¹‹åï¼‰ -->
<div class="study-container">
    <div class="card">
        <button class="exit-btn primary-btn" onclick="exitChallenge()">âŒ é€€å‡º</button>
        <!-- æ–°å¢å‘éŸ³é€‰æ‹©ä¸‹æ‹‰èœå• -->
        <select id="pronunciationType" class="form-input" >
            <option value="UK">ğŸ‡¬ğŸ‡§ è‹±å¼å‘éŸ³</option>
            <option value="US">ğŸ‡ºğŸ‡¸ ç¾å¼å‘éŸ³</option>
        </select>
        <div id="currentWord" class="word-display"></div>
        <input type="text" id="spellInput" class="spell-input" style="display: none;">
        <div class="options" id="options"></div>
        <div class="stats-bar">
            <div>ğŸ•’ ç”¨æ—¶: <span id="timer">0:00</span></div>
            <div>âœ… æ­£ç¡®: <span id="correctCount">0</span></div>
            <div>âŒ é”™è¯¯: <span id="currentWrongCount">0</span></div>
            <div>ğŸ“Š è¿›åº¦: <span id="progress">0/0</span></div>
            <div>ğŸ† åˆ†æ•°: <span id="currentScore">0</span></div>
            <div></div><button class="voice-btn" onclick="speakCurrentWord()">ğŸ”Š</button></div>
        </div>
        
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script>
// ============== å…¨å±€å˜é‡ ==============
// ============== å…¨å±€å˜é‡ ==============
let currentChallengeStats = { correct: 0, wrong: 0, total: 0 };
let words = JSON.parse(localStorage.getItem('words')) || [];

/* ==================== é»˜è®¤ç»Ÿè®¡æ•°æ®ç»“æ„ ==================== */
let stats = JSON.parse(localStorage.getItem('stats')) || {
  normal: { total: 0, correct: 0 },
  review: { total: 0, correct: 0 },
  answers: [],
  wrong: [],
  dailyStudy: [0, 0, 0, 0, 0, 0, 0]
};
// æ·±åº¦åˆå¹¶æ—§æ•°æ®å’Œæ–°ç»“æ„

let currentQuestions = [];
let currentIndex = 0;
let startTime = 0;
let timerInterval;
let resizeTimer; 
// ============== éœ€è¦æ–°å¢çš„å˜é‡ ==============
let initialReviewTotal = 0; // æ–°å¢å…¨å±€å˜é‡å­˜å‚¨å¤ä¹ æ¨¡å¼åˆå§‹æ€»é¢˜æ•°

// ============== æ–°å¢å…¨å±€å˜é‡ ==============
let initialWrongCount = 0; // è®°å½•å¤ä¹ å¼€å§‹æ—¶çš„é”™é¢˜æ€»æ•°

// ============== å…¨å±€å˜é‡ ==============
let tempWrongList = []; // æ–°å¢ä¸´æ—¶é”™é¢˜æœ¬ï¼ˆä¿®å¤é—®é¢˜æ ¸å¿ƒï¼‰

// ============== æ–°å¢å…¨å±€å˜é‡ ==============
let currentMode = 'choice'; // choice/spell
let chartInstance = null;



// ============== è¯­éŸ³åŠŸèƒ½ ==============
function speakCurrentWord() {
    const word = currentQuestions[currentIndex]?.en;
    if (!word) return;
    
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(word);
    const pronunciationType = document.getElementById('pronunciationType').value;
    
    // è®¾ç½®å‘éŸ³å‚æ•°
    utterance.lang = pronunciationType === 'UK' ? 'en-GB' : 'en-US';
    utterance.rate = 0.9;
    utterance.pitch = pronunciationType === 'UK' ? 1.0 : 1.2;

    // å°è¯•æŸ¥æ‰¾å¯¹åº”å‘éŸ³çš„è¯­éŸ³
    const voices = speechSynthesis.getVoices();
    const targetVoice = voices.find(voice => {
        const isTarget = pronunciationType === 'UK' ? 
            voice.voiceURI.includes('British') || voice.lang === 'en-GB' :
            voice.voiceURI.includes('American') || voice.lang === 'en-US';
        return isTarget && voice.localService;
    });

    if (targetVoice) {
        utterance.voice = targetVoice;
    }

    utterance.onstart = () => {
        document.querySelector('.voice-btn').style.background = '#00cc6a';
    };
    utterance.onend = () => {
        document.querySelector('.voice-btn').style.background = '#00ff88';
    };
    
    speechSynthesis.speak(utterance);
}
// ============== æ–°å¢è¯­éŸ³åˆå§‹åŒ– ==============
let voicesReady = false;
speechSynthesis.onvoiceschanged = () => {
    voicesReady = true;
    console.log('è¯­éŸ³åˆ—è¡¨åŠ è½½å®Œæˆ');
};

// ============== å›¾è¡¨åˆå§‹åŒ– ==============
// ============== åˆå§‹åŒ–å›¾è¡¨ ==============
function initChart() {
    const canvas = document.getElementById('progressChart');
    if (!canvas) return;

    // é”€æ¯ç°æœ‰å®ä¾‹
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }

    const ctx = canvas.getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'],
            datasets: [{
                label: 'æ¯æ—¥å­¦ä¹ é‡',
                data: stats.dailyStudy,
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 12 },
                    padding: 10
                }
            },
            scales: {
                y: { 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#fff' }
                },
                x: { 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#fff' }
                }
            }
        }
    });
}
// ============== æ›´æ–°å›¾è¡¨æ•°æ® ==============
function updateChart() {
    if (chartInstance) {
        chartInstance.destroy();
    }
    initChart();
    if (chartInstance) {
        chartInstance.data.datasets[0].data = stats.dailyStudy;
        chartInstance.update();
    }
}
// ============== è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ– ==============
// ============== ä¼˜åŒ–åçš„è™šæ‹Ÿæ»šåŠ¨ ==============
function initVirtualScroll(filteredList = words) {
    const container = document.getElementById('wordList');
    if (!container) return;

     // å¢åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
  let touchY = 0;
  container.addEventListener('touchstart', e => {
    touchY = e.touches[0].clientY;
  }, { passive: true });

  container.addEventListener('touchmove', e => {
    const deltaY = e.touches[0].clientY - touchY;
    container.scrollTop -= deltaY;
    touchY = e.touches[0].clientY;
  }, { passive: true });

  // ä¼˜åŒ–æ»šåŠ¨æ¸²æŸ“
  let renderTimeout;
  function scheduleRender() {
    if (renderTimeout) cancelAnimationFrame(renderTimeout);
    renderTimeout = requestAnimationFrame(updateList);
  }

    // æ¸…ç†æ—§å®ä¾‹
    if (container._virtualScroll) {
        window.cancelAnimationFrame(container._virtualScroll.raf);
        container.removeEventListener('scroll', container._virtualScroll.handler);
        delete container._virtualScroll;
    }

    // æ»šåŠ¨èŠ‚æµ
    let lastUpdate = 0;
    const handler = () => {
        const now = Date.now();
        if (now - lastUpdate > 100) {
            lastUpdate = now;
            updateList();
        }
    };

    // ç»‘å®šæ–°å®ä¾‹
    container._virtualScroll = {
        handler,
        raf: null
    };
    container.addEventListener('scroll', handler);

  // ç©ºçŠ¶æ€å¤„ç†
  if (!filteredList.length) {
    container.innerHTML = '<div class="no-data" style="text-align:center;padding:2rem;color:#666">ğŸ“­ å½“å‰æ²¡æœ‰æ•°æ®</div>';
    return;
  }

  // æ¸…é™¤æ—§ç›‘å¬å™¨
  if (container._scrollHandler) {
    container.removeEventListener('scroll', container._scrollHandler);
    delete container._scrollHandler;
  }

  // åŠ¨æ€è®¡ç®—é¡¹ç›®é«˜åº¦
  const sampleItem = document.createElement('div');
  sampleItem.className = 'word-item';
  sampleItem.innerHTML = '<span>Sample</span>';
  container.appendChild(sampleItem);
  const itemStyle = window.getComputedStyle(sampleItem);
  const itemHeight = sampleItem.offsetHeight + 
    parseInt(itemStyle.marginTop) + 
    parseInt(itemStyle.marginBottom);
  container.removeChild(sampleItem);

  let currentList = filteredList;
  let lastScrollTop = 0;

  // é˜²æŠ–æ»šåŠ¨å¤„ç†
  let isScrolling;
  function handleScroll() {
    window.cancelAnimationFrame(isScrolling);
    isScrolling = window.requestAnimationFrame(() => {
      const currentScrollTop = container.scrollTop;
      if (Math.abs(currentScrollTop - lastScrollTop) > itemHeight * 0.5) {
        lastScrollTop = currentScrollTop;
        updateList();
      }
    });
  }

  function updateList() {
    const containerHeight = container.clientHeight;
    const scrollTop = container.scrollTop;
    const startIdx = Math.max(0, Math.floor(scrollTop / itemHeight) - 8);
    const endIdx = Math.min(
      currentList.length,
      startIdx + Math.ceil(containerHeight / itemHeight) + 15
    );

    container.innerHTML = '';
    container.style.height = `${currentList.length * itemHeight}px`;

    // é¡¶éƒ¨å ä½
    const spacerTop = document.createElement('div');
    spacerTop.style.height = `${startIdx * itemHeight}px`;
    container.appendChild(spacerTop);

    // æ¸²æŸ“å¯è§é¡¹
    currentList.slice(startIdx, endIdx).forEach((word, i) => {
      const div = document.createElement('div');
      div.className = 'word-item';
      div.innerHTML = `
        <span>${startIdx + i + 1}. ${word.en} - ${word.cn}</span>
        <button onclick="handleDeleteWord(event, ${words.indexOf(word)})">ğŸ—‘ï¸</button>
      `;
      container.appendChild(div);
    });

    // åº•éƒ¨å ä½
    const spacerBottom = document.createElement('div');
    spacerBottom.style.height = `${Math.max(0, (currentList.length - endIdx) * itemHeight)}px`;
    container.appendChild(spacerBottom);
  }

  container._scrollHandler = handleScroll;
  container.addEventListener('scroll', handleScroll);
  updateList();
}
// ============== æ‰‹åŠ¿æ“ä½œæ”¯æŒ ==============
function initGestures() {
    const card = document.querySelector('.card');
    const hammer = new Hammer(card);
    
    hammer.on('swipeleft', () => {
        if (currentIndex < currentQuestions.length - 1) {
            currentIndex++;
            showNextQuestion();
        }
    });
    
    hammer.on('swiperight', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showNextQuestion();
        }
    });
}

// ============== Service Worker æ³¨å†Œ ==============
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
        .catch(err => console.warn('Service Worker æ³¨å†Œå¤±è´¥', err));
}
self.addEventListener('fetch', (event) => {
  // æ–°å¢ï¼šAPIè¯·æ±‚ä¸ç¼“å­˜
  if (event.request.url.includes('/api/')) {
    event.respondWith(fetch(event.request));
    return;
  }

  if (event.request.mode === 'navigate') {
    event.respondWith(
      fetch(event.request)
        .catch(() => caches.match(OFFLINE_URL))
    );
  } else {
    event.respondWith(
      caches.match(event.request)
        .then(response => response || fetch(event.request))
    );
  }
});


// ============== å…¶ä»–ä¿æŒä¸å˜çš„æ ¸å¿ƒå‡½æ•° ==============
// ============== é‡æ„åçš„æ˜¾ç¤ºé¢˜ç›®å‡½æ•° ==============
function showNextQuestion() {
    if (currentIndex >= currentQuestions.length) {
        endChallenge();
        return;
    }

    const currentWord = currentQuestions[currentIndex];
    const optionsContainer = document.getElementById('options');
    const spellInput = document.getElementById('spellInput');

    // é‡ç½®æ‰€æœ‰äº¤äº’å…ƒç´ 
    optionsContainer.innerHTML = '';
    spellInput.value = '';
    spellInput.classList.remove('correct', 'wrong');
    spellInput.disabled = false;
    spellInput.placeholder = 'è¾“å…¥ç­”æ¡ˆåæŒ‰å›è½¦æäº¤';

    if (currentMode === 'spell') {
        // ========== æ‹¼å†™æ¨¡å¼å¤„ç† ==========
        document.getElementById('currentWord').innerHTML = `
            <div style="font-size:1.2em;margin:1rem 0">${currentWord.cn}</div>
            <div style="color:#666;font-size:0.9em">è¯·è¾“å…¥å¯¹åº”è‹±æ–‡å•è¯</div>
        `;
        spellInput.style.display = 'block';
        spellInput.focus();

        // ç»‘å®šæ‹¼å†™è¾“å…¥å¤„ç†
        spellInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                const userAnswer = spellInput.value.trim().toLowerCase();
                const correctAnswer = currentWord.en.toLowerCase();
                const isCorrect = userAnswer === correctAnswer;
                
                spellInput.disabled = true;
                spellInput.classList.add(isCorrect ? 'correct' : 'wrong');
                
                // é”™è¯¯æ—¶æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                if (!isCorrect) {
                    spellInput.value = `${userAnswer} â†’ ${currentWord.en}`;
                }
                
                setTimeout(() => {
                    handleAnswer(isCorrect, currentWord);
                    spellInput.classList.remove('correct', 'wrong');
                }, 1500);
            }
        };
    } else {
        // ========== é€‰æ‹©é¢˜æ¨¡å¼å¤„ç† ==========
        document.getElementById('currentWord').textContent = currentWord.en;
        spellInput.style.display = 'none';
        
        const options = getRandomOptions(currentWord);
        optionsContainer.innerHTML = options.map((option, i) => {
            const cleanCN = option.cn.replace(/'/g, "\\'");
            return `<div class="option" onclick="checkAnswer('${cleanCN}')">
                ${String.fromCharCode(65 + i)}. ${option.cn}
            </div>`;
        }).join('');
        optionsContainer.style.display = 'grid';
    }

    // æ›´æ–°è¯­éŸ³æŒ‰é’®çŠ¶æ€
    document.querySelector('.voice-btn').style.display = 'flex';
    updateChallengeDisplay();
}


// ============== æ–°å¢å¯¼å‡ºè¯åº“åŠŸèƒ½ ==============
function exportWords() {
    if(words.length === 0) {
        alert("å½“å‰è¯åº“ä¸ºç©ºï¼Œæ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹");
        return;
    }
    
    const content = words.map((word, index) => 
        `'${word.en.replace(/'/g, "\\'")}''${word.cn.replace(/'/g, "\\'")}'`
    ).join('\n');
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `å•è¯åˆ—è¡¨_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============== æ”¹è¿›çš„ç­”é¢˜å¤„ç†å‡½æ•° ==============
// ============== å¢å¼ºç‰ˆç­”é¢˜å¤„ç† ==============
async function handleAnswer(isCorrect, currentWord) {
  try {
    // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
    stats = stats || {};
    stats.normal = stats.normal || { total: 0, correct: 0 };
    stats.review = stats.review || { total: 0, correct: 0 };
    stats.answers = stats.answers || [];
    stats.wrong = stats.wrong || [];
    stats.dailyStudy = stats.dailyStudy || [0, 0, 0, 0, 0, 0, 0];


    // è®°å½•ç­”æ¡ˆ
    stats.answers.push({
      wordId: `${currentWord.en}|${currentWord.cn}`,
      timestamp: Date.now(),
      isCorrect: isCorrect,
      mode: isReviewMode ? 'review' : 'normal'
    });


    // æ›´æ–°ç»Ÿè®¡
    if (isCorrect) {
      currentChallengeStats.correct++;
      if (isReviewMode) {
        tempWrongList = tempWrongList.filter(w => 
          w.en !== currentWord.en || w.cn !== currentWord.cn
        );
      }
    } else {
      currentChallengeStats.wrong++;
      if (!isReviewMode && !stats.wrong.some(w => 
        w.en === currentWord.en && w.cn === currentWord.cn
      )) {
        stats.wrong.push(currentWord);
      }
    }


    // æ›´æ–°æ¨¡å¼ç»Ÿè®¡
    if (isReviewMode) {
      stats.review.total++;
      if (isCorrect) stats.review.correct++;
    } else {
      stats.normal.total++;
      if (isCorrect) stats.normal.correct++;
    }


    // æ›´æ–°æ¯æ—¥å­¦ä¹ é‡
    const today = new Date().getDay();
    stats.dailyStudy[today] = (stats.dailyStudy[today] || 0) + 1;


    // è‡ªåŠ¨ä¿å­˜
    currentIndex++;
    if (currentIndex >= currentQuestions.length) {
      await saveAllData();
      endChallenge();
    } else {
      setTimeout(() => showNextQuestion(), 1000);
      await saveAllData();
    }


  } catch (e) {
    console.error('å¤„ç†ç­”æ¡ˆæ—¶å‡ºé”™:', e);
    alert('ç­”æ¡ˆå¤„ç†é”™è¯¯ï¼Œæ•°æ®å·²è‡ªåŠ¨ä¿å­˜');
    await saveAllData();
  } finally {
    updateStatsDisplay();
    updateWrongWordsDisplay();
  }
}


// è¯­éŸ³åŠŸèƒ½å®ç°
function speakCurrentWord() {
    try {
    if (!currentQuestions[currentIndex]) return;
    
    // æ–°å¢è¯­éŸ³åˆ—è¡¨å°±ç»ªæ£€æŸ¥
    if (!voicesReady) {
      alert('è¯­éŸ³å¼•æ“æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨åé‡è¯•');
      return;
    }
    if (!currentQuestions[currentIndex]) return;
    
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    
    const utterance = new SpeechSynthesisUtterance(currentQuestions[currentIndex].en);
    utterance.rate = 0.9;
    utterance.pitch = 1.2;
    
    utterance.addEventListener('end', () => {
        document.querySelector('.voice-btn').style.background = '#00ff88';
    });
    
    document.querySelector('.voice-btn').style.background = '#00cc6a';
    speechSynthesis.speak(utterance);
} catch (error) {
    console.error('è¯­éŸ³åˆæˆå¤±è´¥:', error);
    alert('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
  }
}
function getRandomOptions(correctWord) {
    const candidates = words.filter(w => 
        w.en !== correctWord.en && 
        w.cn !== correctWord.cn
    );

      // å»é‡å¤„ç†
      const uniqueCandidates = [...new Map(candidates.map(item => [item.cn, item])).values()];
    
    // éšæœºé€‰å–3ä¸ªé”™è¯¯é€‰é¡¹
    const wrongOptions = [];
    while(wrongOptions.length < 3 && uniqueCandidates.length > 0) {
        const randomIndex = Math.floor(Math.random() * uniqueCandidates.length);
        wrongOptions.push(uniqueCandidates.splice(randomIndex, 1)[0]);
    }
    // ç»„åˆé€‰é¡¹å¹¶æ´—ç‰Œ
    let allOptions = [...wrongOptions, correctWord];
    for(let i = allOptions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
    }
    
    return allOptions.slice(0, 4);
}

function exitChallenge() {
    if(confirm('ç¡®å®šè¦é€€å‡ºå½“å‰å­¦ä¹ å—ï¼Ÿæœªå®Œæˆçš„è¿›åº¦å°†ä¼šä¸¢å¤±ï¼')) {
        clearInterval(timerInterval);
        document.querySelector('.study-container').style.display = 'none';
        document.querySelector('.main-container').style.display = 'block';
        currentQuestions = [];
        currentIndex = 0;
        updateStatsDisplay();
    }
}

// ============== ä¿®å¤æŒ‘æˆ˜ç»“æŸé€»è¾‘ ==============
function endChallenge() {
    // === é€šç”¨æ¸…ç† ===
    if (timerInterval) clearInterval(timerInterval);
    currentIndex = 0;

    // === æ¨¡å¼å¤„ç† ===
    if (isReviewMode) {
        // å¤ä¹ æ¨¡å¼æ›´æ–°å¤ä¹ ç»Ÿè®¡æ•°æ®
        stats.review.total += currentChallengeStats.total;
        stats.review.correct += currentChallengeStats.correct;
        
        // ä¿å­˜æ›´æ–°åçš„é”™é¢˜æœ¬
        stats.wrong = tempWrongList.filter((v, i, a) =>
            a.findIndex(t => (t.en === v.en && t.cn === v.cn)) === i
        );
    } else {
        // æ™®é€šæ¨¡å¼æ›´æ–°æ™®é€šç»Ÿè®¡æ•°æ®
        stats.normal.total += currentChallengeStats.total;
        stats.normal.correct += currentChallengeStats.correct;

        // æ›´æ–°æ¯æ—¥å­¦ä¹ é‡
        const today = new Date().getDay();
        if (stats.dailyStudy && stats.dailyStudy.length > today) {
            stats.dailyStudy[today] += currentChallengeStats.total;
        } else {
            stats.dailyStudy = [0, 0, 0, 0, 0, 0, 0];
            stats.dailyStudy[today] += currentChallengeStats.total;
        }
    }

    // === æŒä¹…åŒ–å­˜å‚¨ ===
    localStorage.setItem('stats', JSON.stringify(stats));
    
    // === æ›´æ–°å›¾è¡¨ ===
    updateChart();

    // === æ˜¾ç¤ºç»“æœ ===
    showResult();

    // === é‡ç½®çŠ¶æ€ ===
    isReviewMode = false;
    tempWrongList = [];
    currentQuestions = [];

    // === è¿”å›ä¸»ç•Œé¢ ===
    document.querySelector('.study-container').style.display = 'none';
    document.querySelector('.main-container').style.display = 'block';
    updateStatsDisplay();  // è°ƒç”¨æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
    updateWrongWordsDisplay();

    // é‡æ–°åˆå§‹åŒ–å›¾è¡¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (!chartInstance) {
        initChart();
    }
}

// ============== ä¿®å¤åçš„ showResult å‡½æ•° ==============
function showResult() {
    let total, correct, modeName;
    
    if(isReviewMode) {
        modeName = "ğŸ“– é”™é¢˜å¤ä¹ ";
        total = initialWrongCount;
        correct = currentChallengeStats.correct;
    } else {
        modeName = "ğŸš€ å­¦ä¹ æŒ‘æˆ˜";
        total = currentChallengeStats.total;
        correct = currentChallengeStats.correct;
    }

    const accuracy = total > 0 ? (correct / total * 100).toFixed(1) : 0;

    const resultHTML = `
        <div class="result-card">
            <div class="result-title">${getResultTitle(accuracy)}</div>
            <div class="result-score">${correct * 10} åˆ†</div>
            <div style="font-size:1.2em;margin-bottom:1.5rem;">
                æ­£ç¡®ç‡ï¼š<span style="color:#00ff88">${accuracy}%</span>
                ${isReviewMode ? '' : `é¢˜é‡ï¼š${total} é¢˜`}
            </div>
            <div class="result-message">${getResultMessage(accuracy)}</div>
        </div>
    `;

    const resultDiv = document.createElement('div');
    resultDiv.innerHTML = resultHTML;
    document.body.appendChild(resultDiv);
    setTimeout(() => resultDiv.remove(), 5000);
}

// ============== æ–°å¢å¤ä¹ æ¨¡å¼æ ‡å¿— ==============
let isReviewMode = false; // æ–°å¢å…¨å±€å˜é‡

// ============== ä¿®å¤å¤ä¹ æ¨¡å¼åˆå§‹åŒ– ==============
async function startReview() {
    if (stats.wrong.length < 1) {
        alert('å½“å‰æ²¡æœ‰è¶³å¤Ÿçš„é”™é¢˜å¯ä¾›å¤ä¹ ');
        return;
    }

    // æ·±æ‹·è´é”™é¢˜åˆ—è¡¨å¹¶å»é‡
    tempWrongList = JSON.parse(JSON.stringify(stats.wrong));
    tempWrongList = tempWrongList.filter((v,i,a) => 
        a.findIndex(t => (t.en === v.en && t.cn === v.cn)) === i
    );

    // åˆå§‹åŒ–é¢˜ç›®åˆ—è¡¨
    currentQuestions = JSON.parse(JSON.stringify(tempWrongList));
    initialWrongCount = currentQuestions.length;

    // é‡ç½®ç»Ÿè®¡çŠ¶æ€
    isReviewMode = true;
    currentIndex = 0;
    startTime = Date.now();
    currentChallengeStats = {
        correct: 0,
        wrong: 0,
        total: initialWrongCount
    };

    // ç•Œé¢åˆå§‹åŒ–
    document.querySelector('.study-container').style.display = 'block';
    document.querySelector('.main-container').style.display = 'none';
    document.getElementById('timer').textContent = "0:00";
    
    clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    showNextQuestion();
    updateChallengeDisplay();
    updateWrongWordsDisplay(); // ç«‹å³æ›´æ–°é”™é¢˜æ˜¾ç¤º

      // è‡ªåŠ¨ä¿å­˜
      await saveAllData(); // æ–°å¢ä¿å­˜ç‚¹
}


// ============== ä¿®å¤æ¸…ç©ºè¯åº“åŠŸèƒ½ ==============
async function deleteAllWords() {
    if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è¯æ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    
    const password = prompt('âš ï¸ è¯·è¾“å…¥ç™»å½•å¯†ç è¿›è¡ŒäºŒæ¬¡éªŒè¯ï¼š');
    if (password !== '001') return alert('å¯†ç éªŒè¯å¤±è´¥');
    
    words = [];
    localStorage.setItem('words', JSON.stringify(words));
    renderWordList(); // æ–°å¢ï¼šæ¸…ç©ºååˆ·æ–°è¯åº“æ˜¾ç¤º
    alert('å·²æˆåŠŸæ¸…ç©ºæ‰€æœ‰è¯æ¡');
    
    // åŒæ­¥æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
    updateStatsDisplay();
    document.getElementById('searchInput').value = '';

     // è‡ªåŠ¨ä¿å­˜
     await saveAllData(); // æ–°å¢ä¿å­˜ç‚¹
}

// ============== ç™»å½•ä¸åˆå§‹åŒ– ==============
// ä¿®æ”¹åçš„ç™»å½•å‡½æ•°
async function login(e) {
    e.preventDefault();
    const button = document.querySelector('button[type="submit"]');
    try {
        button.disabled = true;
        button.textContent = 'ç™»å½•ä¸­...';

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (username === 'Timi' && password === '001') {
            await loadAllData(); // å…ˆåŠ è½½æ•°æ®
            initSystem(); // ååˆå§‹åŒ–
            return true;
        }
        alert('è´¦å·æˆ–å¯†ç é”™è¯¯ï¼');
    } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error);
        alert('ç™»å½•è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸');
    } finally {
        button.disabled = false;
        button.textContent = 'è¿›å…¥ç³»ç»Ÿ';
    }
    return false;
}
// ä¿®æ”¹åçš„åˆå§‹åŒ–å‡½æ•°
function initSystem() {
  // æ–°å¢ç½‘ç»œçŠ¶æ€æç¤ºæ¡
  const networkStatus = document.createElement('div');
  networkStatus.id = 'network-status';
  networkStatus.style = `position:fixed;
    top:0;
    left:0;
    right:0;
    padding:8px;
    text-align:center;
    z-index:9999;
    background:${navigator.onLine ? '#00ff88' : '#ff4444'};
    color:#16213e;
    font-weight:bold;
    transition:all 0.3s ease`;
  networkStatus.textContent = navigator.onLine ? 
    'âœ“ å·²è¿æ¥ç½‘ç»œ' : 'âš ï¸ å½“å‰å¤„äºç¦»çº¿æ¨¡å¼';
  document.body.prepend(networkStatus);

  // å®æ—¶æ£€æµ‹ç½‘ç»œçŠ¶æ€
  window.addEventListener('online', () => {
    networkStatus.style.background = '#00ff88';
    networkStatus.textContent = 'âœ“ ç½‘ç»œå·²æ¢å¤ï¼Œæ•°æ®è‡ªåŠ¨åŒæ­¥ä¸­...';
    setTimeout(() => networkStatus.remove(), 3000);
    syncWithGitHub();
  });

  window.addEventListener('offline', () => {
    networkStatus.style.background = '#ff4444';
    networkStatus.textContent = 'âš ï¸ å½“å‰å¤„äºç¦»çº¿æ¨¡å¼';
  });

  // å…³é”®å…ƒç´ æ£€æŸ¥
  const requiredElements = ['#wordList', '#progressChart', '#mobileNav'];
  requiredElements.forEach(selector => {
    if (!document.querySelector(selector)) {
      console.error(`å…³é”®å…ƒç´ ç¼ºå¤±: ${selector}`);
      return;
    }
  });

    document.querySelector('.login-container').style.display = 'none';
    document.querySelector('.main-container').style.display = 'block';

    // ç¡®ä¿æ­£ç¡®åˆ†é…åˆ—ID
    const columns = document.querySelectorAll('.column');
    ['wordLib', 'studyMode', 'statsPanel'].forEach((id, index) => {
        if(columns[index]) columns[index].id = id;
    });

    // é¦–æ¬¡åŠ è½½æ—¶æ£€æµ‹å±å¹•å°ºå¯¸
    if(window.innerWidth <= 1024) {
        document.getElementById('mobileNav').style.display = 'flex';
        showSection('wordLib');
    } else {
        document.querySelectorAll('.column').forEach(col => {
            col.style.display = 'flex';
        });
        document.getElementById('mobileNav').style.display = 'none';
    }

    // ä¿æŒåŸæœ‰åˆå§‹åŒ–é€»è¾‘
    renderWordList();
    startClock(); // å¯åŠ¨æ—¶é’Ÿ
    initSearch();
    updateStatsDisplay();
    updateWrongWordsDisplay();
    initParticles();

    setTimeout(() => {
        if (!document.getElementById('progressChart')) {
            const canvas = document.createElement('canvas');
            canvas.id = 'progressChart';
            document.getElementById('dashboard').appendChild(canvas);
        }
        
        if (typeof Chart !== 'undefined') initChart();
        if (document.getElementById('wordList')) initVirtualScroll();
        if (document.querySelector('.card')) initGestures();
    }, 500);

     // æ–°å¢é‡è¯•æœºåˆ¶
  let chartInitAttempts = 0;
  const initChartWithRetry = () => {
    if (typeof Chart === 'undefined' && chartInitAttempts < 3) {
      chartInitAttempts++;
      setTimeout(initChartWithRetry, 1000);
    } else {
      initChart();
    }
  };
  initChartWithRetry();
}


// ä¿®æ”¹åçš„çª—å£resizeç›‘å¬
function handleResize() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        const isMobileView = window.innerWidth <= 1024;
        
        if (isMobileView) {
            document.getElementById('mobileNav').style.display = 'flex';
            if(!document.querySelector('.column[style*="display: flex"]')) {
                showSection('wordLib');
            }
        } else {
            document.querySelectorAll('.column').forEach(col => {
                col.style.display = 'flex';
            });
            document.getElementById('mobileNav').style.display = 'none';
        }
        
        // å¼ºåˆ¶é‡æ–°è®¡ç®—è™šæ‹Ÿæ»šåŠ¨
        initVirtualScroll();
        if (chartInstance) chartInstance.resize();
    }, 300);
}

// åˆå§‹åŒ–ç›‘å¬
window.addEventListener('resize', handleResize);
handleResize(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡

// ============== æ–°å¢çª—å£resizeç›‘å¬ ==============

window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        if(window.innerWidth > 1024) {
            // æ¡Œé¢ç«¯æ¢å¤æ˜¾ç¤º
            document.querySelectorAll('.column').forEach(col => {
                col.style.display = 'flex';
            });
            document.getElementById('mobileNav').style.display = 'none';
        } else {
            // ç§»åŠ¨ç«¯åˆ‡æ¢å¸ƒå±€
            document.getElementById('mobileNav').style.display = 'flex';
            showSection('wordLib');
        }
    }, 200);
});


// ============== å•è¯æ“ä½œ ==============
async function addWord(e) {
    e.preventDefault();
    const en = document.getElementById('enInput').value.trim();
    const cn = document.getElementById('cnInput').value.trim();

    if(!en || !cn) return alert('è¯·å¡«å†™å®Œæ•´å†…å®¹');
    if(words.some(w => w.en === en && w.cn === cn)) return alert('å•è¯å·²å­˜åœ¨');

    words.push({ en, cn });
    
    // å¼ºåˆ¶æ›´æ–°è™šæ‹Ÿæ»šåŠ¨
    const currentScrollPos = document.getElementById('wordList').scrollTop;
    renderWordList();
    document.getElementById('wordList').scrollTop = currentScrollPos;
    
    document.getElementById('enInput').value = '';
    document.getElementById('cnInput').value = '';
    toggleWordForm();

    // è‡ªåŠ¨ä¿å­˜
    await saveAllData(); // æ–°å¢ä¿å­˜ç‚¹
}

async function handleDeleteWord(event, originalIndex) {
    event.stopPropagation();
    if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯æ¡å—ï¼Ÿ')) return;
    
    words.splice(originalIndex, 1);
    renderWordList(); 

    // è‡ªåŠ¨ä¿å­˜
    await saveAllData(); // æ–°å¢ä¿å­˜ç‚¹
}

function toggleWordForm() {
    const form = document.getElementById('wordForm');
    const isShowing = form.style.display === 'block';
    
    form.style.display = isShowing ? 'none' : 'block';
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ
    if (!isShowing) {
        setTimeout(() => {
            const container = document.querySelector('.column:first-child');
            const formTop = document.getElementById('wordForm').offsetTop;
            container.scrollTo({
                top: formTop - 80,
                behavior: 'smooth'
            });
        }, 50);
    }
}

// ============== æ–‡ä»¶æ“ä½œ ==============
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            const content = e.target.result;
            const lines = content.split('\n');
            let importedCount = 0;
            let duplicateCount = 0;
            let formatErrorCount = 0;

            // ä¸¥æ ¼çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
            const wordRegExp = /^'((?:\\'|[^'])*?)''((?:\\'|[^'])*?)'$/;

            // ç¬¬ä¸€éï¼šéªŒè¯æ–‡ä»¶æ ¼å¼
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                if (!wordRegExp.test(trimmed)) {
                    formatErrorCount++;
                }
            }

            if (formatErrorCount > 0) {
                if (!confirm(`å‘ç°${formatErrorCount}å¤„æ ¼å¼é”™è¯¯ï¼Œæ˜¯å¦ç»§ç»­å¯¼å…¥ï¼Ÿ`)) return;
            }

            // ç¬¬äºŒéï¼šå¤„ç†æ•°æ®
            for (const [index, line] of lines.entries()) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                const match = trimmed.match(wordRegExp);
                if (!match) {
                    console.warn(`è·³è¿‡ç¬¬ ${index + 1} è¡Œï¼šæ ¼å¼é”™è¯¯`);
                    continue;
                }

                const en = match[1].replace(/\\'/g, "'").trim();
                const cn = match[2].replace(/\\'/g, "'").trim();

                // æœ‰æ•ˆæ€§æ£€æŸ¥
                if (!en || !cn) {
                    console.warn(`è·³è¿‡ç¬¬ ${index + 1} è¡Œï¼šå†…å®¹ä¸ºç©º`);
                    formatErrorCount++;
                    continue;
                }

                // å»é‡æ£€æŸ¥ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                const exists = words.some(w => 
                    w.en.toLowerCase() === en.toLowerCase() && 
                    w.cn.toLowerCase() === cn.toLowerCase()
                );

                if (!exists) {
                    words.push({ en, cn });
                    importedCount++;
                } else {
                    duplicateCount++;
                }
            }

            // æœ¬åœ°å­˜å‚¨æ›´æ–°
            localStorage.setItem('words', JSON.stringify(words));
            renderWordList();

            // äº‘åŒæ­¥
            try {
                await saveAllData();
                alert(`æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªå•è¯\n` +
                      `é‡å¤é¡¹ï¼š${duplicateCount}\n` +
                      `æ ¼å¼é”™è¯¯ï¼š${formatErrorCount}`);
            } catch (error) {
                alert(`å¯¼å…¥æˆåŠŸä½†åŒæ­¥å¤±è´¥ï¼š${error.message}\n` +
                      'æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡è”ç½‘æ—¶å°†è‡ªåŠ¨åŒæ­¥');
            }
            
        } catch (error) {
            alert(`æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š${error.message}`);
        } finally {
            // æ¸…ç©ºè¾“å…¥ä»¥ä¾¿é‡å¤ä¸Šä¼ ç›¸åŒæ–‡ä»¶
            e.target.value = '';
        }
    };

    reader.onerror = function() {
        alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼");
    };

    reader.readAsText(file, 'UTF-8');
});
// ============== æ–°å¢/ä¿®å¤çš„ç»Ÿè®¡æ›´æ–°é€»è¾‘ ==============
// ============== ç¬¬ä¸€éƒ¨åˆ†ï¼šæ›´æ–°æŒ‘æˆ˜æ˜¾ç¤º ==============
function updateChallengeDisplay() {
    // è®¡ç®—æ€»é¢˜æ•°ï¼šå¤ä¹ æ¨¡å¼ä½¿ç”¨åˆå§‹é”™é¢˜æ•°ï¼Œæ™®é€šæ¨¡å¼ä½¿ç”¨å½“å‰é¢˜ç›®æ€»æ•°
    const totalQuestions = isReviewMode ? 
        initialWrongCount : 
        currentChallengeStats.total;

    // æ›´æ–°æ¶ˆç­æ•Œäººï¼ˆæ­£ç¡®æ•°ï¼‰æ˜¾ç¤º
    document.getElementById('correctCount').textContent = currentChallengeStats.correct;
    
    // æ›´æ–°é­é‡ä¼å‡»ï¼ˆé”™è¯¯æ•°ï¼‰æ˜¾ç¤º
    document.getElementById('currentWrongCount').textContent = currentChallengeStats.wrong;
    
    // æ›´æ–°å½“å‰è¿›åº¦æ˜¾ç¤ºï¼ˆæ ¼å¼ï¼šå½“å‰é¢˜å·/æ€»é¢˜æ•°ï¼‰
    document.getElementById('progress').textContent = `${currentIndex + 1}/${totalQuestions}`;
    
    // æ›´æ–°å½“å‰æˆ˜ç»©ï¼ˆæ­£ç¡®æ•° Ã— 10ï¼‰
    document.getElementById('currentScore').textContent = currentChallengeStats.correct * 10;
}


// ============== å­¦ä¹ æŒ‘æˆ˜ ==============
function startLearning() {
    const count = parseInt(document.getElementById('challengeCount').value);
    currentMode = document.getElementById('challengeMode').value;
    
    // æ–°å¢å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
    const requiredElements = ['options', 'spellInput', 'currentWord'];
    requiredElements.forEach(id => {
        if (!document.getElementById(id)) {
            console.error(`Missing required element: #${id}`);
            return;
        }
    });

    if ((currentMode === 'choice' && words.length < 4) || (currentMode === 'spell' && words.length < 1)) {
        alert(currentMode === 'choice' ? 'è‡³å°‘éœ€è¦4ä¸ªå•è¯' : 'è‡³å°‘éœ€è¦1ä¸ªå•è¯');
        return;
    }

    currentChallengeStats = { 
        correct: 0, 
        wrong: 0, 
        total: Math.min(count, words.length)
    };
    currentQuestions = getRandomElements(words, currentChallengeStats.total);
    currentIndex = 0;
    startTime = Date.now();

    // åˆå§‹åŒ–æ¯æ—¥å­¦ä¹ é‡ï¼ˆå¦‚æœæœªåˆå§‹åŒ–ï¼‰
    if (!stats.dailyStudy || stats.dailyStudy.length !== 7) {
        stats.dailyStudy = [0, 0, 0, 0, 0, 0, 0];
    }

    // æ˜¾ç¤ºå­¦ä¹ å®¹å™¨
    document.querySelector('.study-container').style.display = 'block';
    document.querySelector('.main-container').style.display = 'none';
    
    // åˆå§‹åŒ–å¿…è¦å…ƒç´ 
    document.getElementById('spellInput').style.display = currentMode === 'spell' ? 'block' : 'none';
    document.getElementById('options').innerHTML = '';
    document.querySelector('.voice-btn').style.display = 'flex';

    clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    showNextQuestion();
}

// ============== ä¿®å¤ç­”é¢˜é€»è¾‘ ==============
function checkAnswer(selectedCn) {
    const correctWord = currentQuestions[currentIndex];
    const isCorrect = selectedCn === correctWord.cn;
    
    // é«˜äº®é€‰é¡¹å¹¶ç¦ç”¨äº¤äº’
    const options = document.querySelectorAll('.option');
    options.forEach(option => {
        const cn = option.textContent.split('. ')[1].trim();
        option.classList.add('disabled');
        if (cn === correctWord.cn) option.classList.add('correct');
        if (cn === selectedCn && !isCorrect) option.classList.add('wrong');
    });

    // å»¶è¿Ÿå¤„ç†ç­”æ¡ˆ
    setTimeout(() => {
        handleAnswer(isCorrect, correctWord);
    }, 1500);
}
    

    
 
// ============== å·¥å…·å‡½æ•° ==============
function getRandomElements(arr, n) {
    const shuffled = [...arr].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, n);
}

function getResultTitle(accuracy) {
    const titles = {30:"ğŸ§¨ å‰æ–¹æ ¸èƒ½é¢„è­¦ï¼",50:"ğŸ›¸ å¤–æ˜ŸäººæŠ“èµ°çŸ¥è¯†å•¦",70:"ğŸ¢ è¿‡å±±è½¦ä½“éªŒåˆ¸",85:"ğŸ¯ ç²¾å‡†æ‰“å‡»ä¸“å®¶",100:"ğŸš€ çŸ¥è¯†ç«ç®­å‘å°„",101:"ğŸ‘‘ æ¬¡å…ƒå£ç ´åè€…"};
    return titles[accuracy == 100 ? 101 : Math.floor(accuracy/10)*10] || titles[30];
}

function getResultMessage(accuracy) {
    const messages = {30:"æ£€æµ‹åˆ°çŸ¥è¯†é»‘æ´ï¼<br>å»ºè®®å¼€å¯'å­¦éœ¸æ¨¡å¼'ç´§æ€¥å……ç”µï¼",50:"å·®ä¸€ä¸¢ä¸¢å°±åŠæ ¼å•¦ï¼<br>æ‚¨çš„çŸ¥è¯†å¯èƒ½è¢«å–µæ˜Ÿäººå·èµ°äº†~",70:"æ­å–œè·å¾—'ç¨³å®šå‘æŒ¥'æˆå°±ï¼<br>å†åŠªåŠªåŠ›å°±èƒ½çªç ´å¤©é™…å•¦ï¼",85:"ç³»ç»Ÿæ£€æµ‹åˆ°å­¦éœ¸æ³¢åŠ¨ï¼<br>ç»§ç»­ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼",100:"è­¦æŠ¥ï¼å‘ç°éšè—å­¦éœ¸ï¼<br>å»ºè®®ç«‹å³æŠ¥å'æœ€å¼ºå¤§è„‘'ï¼"};
    return messages[accuracy == 100 ? 100 : Math.floor(accuracy/10)*10] || messages[30];
}


function updateTimer() {
    const seconds = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('timer').textContent = 
        `${Math.floor(seconds / 60)}:${String(seconds % 60).padStart(2, '0')}`;
}

function highlightOptions(correctCn, selectedCn) {
    const options = document.querySelectorAll('.option');
    options.forEach(option => {
        const cn = option.textContent.split('. ')[1].trim();
        option.classList.add('disabled');
        if (cn === correctCn) option.classList.add('correct');
        if (cn === selectedCn && cn !== correctCn) option.classList.add('wrong');
    });
}

function resetOptions() {
    document.querySelectorAll('.option').forEach(option => {
        option.className = 'option';
    });
}

// ============== ç•Œé¢æ›´æ–° ==============
function renderWordList() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const filteredList = searchTerm ? 
        words.filter(word => 
            word.en.toLowerCase().includes(searchTerm) || 
            word.cn.toLowerCase().includes(searchTerm)
        ) : [...words];

    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
    const countElement = document.getElementById('wordCount');
    countElement.textContent = `${words.length}ä¸ªå•è¯ï¼ˆå½“å‰æ˜¾ç¤º${filteredList.length}ä¸ªï¼‰`;
    
    // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–è™šæ‹Ÿæ»šåŠ¨
    initVirtualScroll(filteredList);
}
function updateStatsDisplay() {
    try {
        const answers = stats?.answers || [];
        const wrong = stats?.wrong || [];
        
        const learnedWords = new Set(answers.map(a => a?.wordId)).size;
        const totalWords = words.length;

        const normalTotal = stats.normal?.total || 0;
        const normalCorrect = stats.normal?.correct || 0;
        const reviewTotal = stats.review?.total || 0;
        const reviewCorrect = stats.review?.correct || 0;

        const normalAccuracy = normalTotal > 0 ? 
            (normalCorrect / normalTotal * 100).toFixed(1) : 0;
        const reviewAccuracy = reviewTotal > 0 ? 
            (reviewCorrect / reviewTotal * 100).toFixed(1) : 0;
        const progress = totalWords > 0 ? 
            Math.min((learnedWords / totalWords * 100), 100).toFixed(1) : 0;

        document.getElementById('normalAccuracy').textContent = `${normalAccuracy}%`;
        document.getElementById('reviewAccuracy').textContent = `${reviewAccuracy}%`;
        document.getElementById('progressRate').textContent = `${progress}%`;
        document.getElementById('wrongCount').textContent = `(${wrong.length})`;
        document.getElementById('reviewBtn').style.display = 
            wrong.length >= 10 ? 'block' : 'none';

    } catch (error) {
        console.error('æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
    }
}

function updateWrongWordsDisplay() {
    const wrongWordsDiv = document.getElementById('wrongWords');
    const wrongCount = stats.wrong.length;
    document.getElementById('wrongCount').textContent = `(${wrongCount})`;
    
    wrongWordsDiv.innerHTML = stats.wrong.map((word, index) => `
        <div class="word-item">
            <span>${index+1}. ${word.en} - ${word.cn}</span>
        </div>
    `).join('');
    
    document.getElementById('reviewBtn').style.display = 
        wrongCount >= 10 ? 'block' : 'none';
}

// === å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆä¾‹å¦‚æ”¾åœ¨ updateWrongWordsDisplay å‡½æ•°å¤–éƒ¨ï¼‰ ===
function exportWrongWords() {
    if(stats.wrong.length === 0) {
        alert("å½“å‰æ²¡æœ‰é”™é¢˜å¯å¯¼å‡º");
        return;
    }
    
    const content = stats.wrong.map((word, index) => 
        `${index + 1}. ${word.en} -> ${word.cn}`
    ).join('\n');
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `é”™é¢˜åˆ—è¡¨_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============== ç³»ç»ŸåŠŸèƒ½ ==============
function startClock() {
    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']; // æ˜ŸæœŸå‡ æ˜ å°„
    setInterval(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const dayOfWeek = days[now.getDay()]; // è·å–æ˜ŸæœŸå‡ 

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        const timeString = `${year}-${month}-${day} ${hours}:${minutes} ${dayOfWeek}`;
        document.getElementById('currentTime').textContent = timeString;
    }, 1000);
}

function initSearch() {
    document.getElementById('searchInput').addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();
        renderWordList(); // è‡ªåŠ¨è§¦å‘è™šæ‹Ÿæ»šåŠ¨æ›´æ–°
    });
}

// ============== æ–°å¢ç§»åŠ¨ç«¯æ¿å—åˆ‡æ¢åŠŸèƒ½ ==============
// ============== ç»Ÿä¸€ä¼˜åŒ–åçš„æ¿å—åˆ‡æ¢å‡½æ•° ==============
function showSection(sectionId) {
    console.log(`åˆ‡æ¢æ¿å—: ${sectionId}ï¼Œå½“å‰å®½åº¦: ${window.innerWidth}px`);

    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === sectionId);
    });

    if (window.innerWidth > 1024) {
        document.querySelectorAll('.column').forEach(col => {
            col.style.display = 'flex';
        });
        document.getElementById('mobileNav').style.display = 'none';
        return;
    }

    const allColumns = document.querySelectorAll('.column');
    let targetFound = false;

    allColumns.forEach(col => {
        if (col.id === sectionId) {
            col.classList.add('active-section');
            targetFound = true;
        } else {
            col.classList.remove('active-section');
        }
    });

    if (!targetFound) {
        document.getElementById('wordLib')?.classList.add('active-section');
    }

    setTimeout(() => {
        if (sectionId === 'wordLib') {
            const wordList = document.getElementById('wordList');
            if (wordList) {
                wordList.scrollTop = 0;
                initVirtualScroll();
            }
        }
        if (sectionId === 'statsPanel' && chartInstance) {
            chartInstance.resize();
        }
    }, 300);
}

function initParticles() {
    particlesJS('particles-js', {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: '#00ff88' },
            shape: { type: 'circle' },
            opacity: { value: 0.5, random: false },
            size: { value: 3, random: true },
            move: {
                enable: true,
                speed: 1.5,
                direction: 'none',
                random: false,
                straight: false,
                out_mode: 'out',
                bounce: false
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'repulse' },
                onclick: { enable: true, mode: 'push' },
                resize: true
            }
        },
        retina_detect: true
    });
}

window.onload = initParticles;

// ============== GitHub åŒæ­¥æ¨¡å— ==============
/* ==================== GitHub åŒæ­¥é…ç½® ==================== */
const GITHUB = {
  REPO_OWNER: 'reabrit',    // æ›¿æ¢ä¸ºä½ çš„GitHubç”¨æˆ·å
  REPO_NAME: 'reabrit.github.io',           // æ•°æ®å­˜å‚¨ä»“åº“åç§°
  DATA_PATH: 'data/words.json',          // æ•°æ®æ–‡ä»¶å­˜å‚¨è·¯å¾„
  TOKEN: null,
  MAX_RETRIES: 3,                        // æœ€å¤§é‡è¯•æ¬¡æ•°
  RETRY_DELAY: 1500                      // é‡è¯•é—´éš”(æ¯«ç§’)
};
async function getGitHubToken() {
    if (!GITHUB.TOKEN) {
        GITHUB.TOKEN = localStorage.getItem('github_token') || 
            await new Promise(resolve => {
                const token = prompt('è¯·è¾“å…¥GitHubè®¿é—®ä»¤ç‰Œ:');
                if (token) {
                    localStorage.setItem('github_token', token);
                    resolve(token);
                } else {
                    resolve(null);
                }
            });
    }
    return GITHUB.TOKEN;
}

async function saveAllData() {
    const token = await getGitHubToken();
    if (!token) {
        alert('éœ€è¦GitHubä»¤ç‰Œè¿›è¡ŒåŒæ­¥');
        return false;
    }

    let retries = GITHUB.MAX_RETRIES;
    while (retries-- > 0) {
        try {
            // ...åŸæœ‰ä¿å­˜é€»è¾‘...
        } catch (e) {
            if (retries === 0) {
                console.error('æœ€ç»ˆåŒæ­¥å¤±è´¥:', e);
                throw e;
            }
            await new Promise(r => setTimeout(r, GITHUB.RETRY_DELAY));
        }
    }
}
/* ==================== é»˜è®¤ç»Ÿè®¡æ•°æ®ç»“æ„ ==================== */
const defaultStats = {
  normal: { total: 0, correct: 0 },      // æ™®é€šæ¨¡å¼ç»Ÿè®¡
  review: { total: 0, correct: 0 },      // å¤ä¹ æ¨¡å¼ç»Ÿè®¡
  answers: [],                           // ç­”é¢˜è®°å½•
  wrong: [],                             // é”™é¢˜åˆ—è¡¨
  dailyStudy: [0, 0, 0, 0, 0, 0, 0]      // æ¯å‘¨å­¦ä¹ é‡ç»Ÿè®¡
};

/* ==================== è¾…åŠ©å‡½æ•°ï¼šæ•°ç»„åˆå¹¶å»é‡ ==================== 
   å‚æ•°ï¼š
   - local: æœ¬åœ°æ•°ç»„
   - remote: è¿œç¨‹æ•°ç»„ 
   - key: ç”¨äºå»é‡çš„å¯¹è±¡é”®
*/
function mergeArrays(local, remote, key) {
  const map = new Map();
  // åˆå¹¶ä¸¤ä¸ªæ•°ç»„å¹¶æ ¹æ®æŒ‡å®škeyå»é‡
  [...local, ...remote].forEach(item => map.set(item[key], item));
  return Array.from(map.values());
}

/* ==================== è¾…åŠ©å‡½æ•°ï¼šæ·±åº¦åˆå¹¶å¯¹è±¡ ====================
   å‚æ•°ï¼š
   - target: ç›®æ ‡å¯¹è±¡
   - source: æºå¯¹è±¡
*/
function deepMerge(target, source) {
  for (const key of Object.keys(source)) {
    // é€’å½’åˆå¹¶å­å¯¹è±¡
    if (source[key] instanceof Object && !Array.isArray(source[key])) {
      Object.assign(source[key], deepMerge(target[key] || {}, source[key]));
    }
  }
  return { ...target, ...source };
}

/* ==================== æ•°æ®ä¿å­˜åˆ°GitHub ==================== */
async function saveAllData() {
  let retries = GITHUB.MAX_RETRIES;
  
  while (retries > 0) {
    try {
      showLoading('æ•°æ®åŒæ­¥ä¸­...');
      
      // å‡†å¤‡åŒæ­¥æ•°æ®
      const data = {
        words: words,         // å•è¯åˆ—è¡¨
        stats: stats,         // ç»Ÿè®¡ä¿¡æ¯
        timestamp: Date.now() // æ—¶é—´æˆ³
      };

      // è·å–æ–‡ä»¶SHAï¼ˆç”¨äºæ›´æ–°å·²æœ‰æ–‡ä»¶ï¼‰
      const sha = await getFileSHA();
      
      // æ„å»ºAPIè¯·æ±‚
      const url = `https://api.github.com/repos/${GITHUB.REPO_OWNER}/${GITHUB.REPO_NAME}/contents/${GITHUB.DATA_PATH}`;
      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          Authorization: `token ${GITHUB.TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `æ•°æ®æ›´æ–° @ ${new Date().toLocaleString()}`,  // æäº¤ä¿¡æ¯
          content: btoa(unescape(encodeURIComponent(JSON.stringify(data)))), // Base64ç¼–ç æ•°æ®
          sha: sha // æ–‡ä»¶ç‰ˆæœ¬æ ‡è¯†
        })
      });

      // å¤„ç†HTTPé”™è¯¯çŠ¶æ€
      if (!res.ok) throw new Error(`HTTPé”™è¯¯ ${res.status}`);
      
      // è§£æå“åº”æ•°æ®
      const responseData = await res.json();
      console.log('åŒæ­¥æˆåŠŸ:', responseData);
      return true;
    } catch (e) {
      retries--;
      
      // æœ€ç»ˆé‡è¯•å¤±è´¥å¤„ç†
      if (retries === 0) {
        if (navigator.onLine) {
          alert(`åŒæ­¥å¤±è´¥: ${e.message}`);
        } else {
          console.log('ç¦»çº¿çŠ¶æ€ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
          // ç¦»çº¿æ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
          localStorage.setItem('words', JSON.stringify(words));
          localStorage.setItem('stats', JSON.stringify(stats));
        }
        return false;
      }
      
      // å»¶è¿Ÿé‡è¯•
      await new Promise(resolve => setTimeout(resolve, GITHUB.RETRY_DELAY));
    } finally {
      hideLoading();
    }
  }
}

/* ==================== ä»GitHubåŠ è½½æ•°æ® ==================== */
async function loadAllData() {
  let retries = GITHUB.MAX_RETRIES;
  
  while (retries > 0) {
    try {
      showLoading('åŠ è½½æ•°æ®ä¸­...');
      
      // æ„å»ºAPIè¯·æ±‚
      const url = `https://api.github.com/repos/${GITHUB.REPO_OWNER}/${GITHUB.REPO_NAME}/contents/${GITHUB.DATA_PATH}`;
      const res = await fetch(url, {
        headers: { Authorization: `token ${GITHUB.TOKEN}` }
      });
      
      // å¤„ç†HTTPé”™è¯¯çŠ¶æ€
      if (!res.ok) throw new Error(`HTTPé”™è¯¯ ${res.status}`);
      
      // è§£æå“åº”æ•°æ®
      const data = await res.json();
      const decoded = decodeURIComponent(atob(data.content)); // Base64è§£ç 
      
      // åˆå¹¶è¿œç¨‹æ•°æ®
      const { words: remoteWords, stats: remoteStats } = JSON.parse(decoded);
      words = mergeArrays(words, remoteWords, 'en');
      stats = deepMerge(stats, remoteStats);
      
      // æ›´æ–°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('words', JSON.stringify(words));
      localStorage.setItem('stats', JSON.stringify(stats));
      
      return true;
    } catch (e) {
      retries--;
      
      // æœ€ç»ˆé‡è¯•å¤±è´¥å¤„ç†
      if (retries === 0) {
        if (navigator.onLine) {
          alert(`åŠ è½½å¤±è´¥: ${e.message}`);
        } else {
          console.log('ç¦»çº¿æ¨¡å¼ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
          // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
          words = JSON.parse(localStorage.getItem('words')) || [];
          stats = JSON.parse(localStorage.getItem('stats')) || defaultStats;
          return true;
        }
        return false;
      }
      
      // å»¶è¿Ÿé‡è¯•
      await new Promise(resolve => setTimeout(resolve, GITHUB.RETRY_DELAY));
    } finally {
      hideLoading();
    }
  }
}

/* ==================== è·å–æ–‡ä»¶SHAå€¼ ==================== */
async function getFileSHA() {
  try {
    const url = `https://api.github.com/repos/${GITHUB.REPO_OWNER}/${GITHUB.REPO_NAME}/contents/${GITHUB.DATA_PATH}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.sha; // è¿”å›æ–‡ä»¶å”¯ä¸€æ ‡è¯†
  } catch (e) {
    console.log('è·å–SHAå¤±è´¥:', e.message);
    return null; // æ–‡ä»¶ä¸å­˜åœ¨æ—¶è¿”å›null
  }
}

// è·å–æ–‡ä»¶SHA
async function getFileSHA() {
  try {
    const url = `https://api.github.com/repos/${GITHUB.REPO_OWNER}/${GITHUB.REPO_NAME}/contents/${GITHUB.DATA_PATH}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.sha;
  } catch {
    return null;
  }
}

// æ•°æ®åˆå¹¶å·¥å…·å‡½æ•°
function mergeArrays(local, remote, key) {
  const map = new Map();
  [...local, ...remote].forEach(item => map.set(item[key], item));
  return Array.from(map.values());
}

function deepMerge(target, source) {
  for (const key of Object.keys(source)) {
    if (source[key] instanceof Object && !Array.isArray(source[key])) {
      Object.assign(source[key], deepMerge(target[key] || {}, source[key]));
    }
  }
  return { ...target, ...source };
}

// åŠ è½½æç¤º
function showLoading(text) {
  const loader = document.createElement('div');
  loader.id = 'sync-loader';
  loader.style = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  loader.innerHTML = `
    <div class="loading-content" style="
      background: #16213e;
      padding: 2rem;
      border-radius: 12px;
      border: 1px solid #00ff88;
      text-align: center;
      min-width: 280px;
    ">
      <div class="spinner" style="
        width: 40px;
        height: 40px;
        border: 4px solid #00ff88;
        border-radius: 50%;
        border-top-color: transparent;
        margin: 0 auto 1rem;
        animation: spin 1s linear infinite;
      "></div>
      <div class="loading-text" style="
        color: #00ff88;
        font-size: 1.1rem;
        margin-bottom: 1rem;
      ">${text}</div>
      <div class="loading-progress" style="
        height: 3px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        overflow: hidden;
      ">
        <div class="progress-bar" style="
          height: 100%;
          width: 0%;
          background: #00ff88;
          transition: width 0.3s ease;
        "></div>
      </div>
    </div>
  `;

  // åŠ¨æ€æ ·å¼
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes progress {
      0% { width: 0%; opacity: 1; }
      90% { width: 90%; opacity: 1; }
      100% { width: 100%; opacity: 0; }
    }
    .progress-bar {
      animation: progress 2500ms ease-in-out infinite;
    }
  `;
  
  document.head.appendChild(style);
  document.body.appendChild(loader);
}

function hideLoading() {
  // ç§»é™¤åŠ¨æ€æ ·å¼
  document.querySelectorAll('style').forEach(s => {
    if (s.textContent.includes('progress') || s.textContent.includes('spin')) {
      s.remove();
    }
  });
  
  const loader = document.getElementById('sync-loader');
  if (loader) loader.remove();
}
    </script>
</body>